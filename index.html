<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>crafty</title>
    <!-- Import Google Icon Font-->
    <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Import materialize css -->
    <link rel="stylesheet" type="text/css" href="./libs/materialize/css/materialize.min.css" media="screen,projection"/>
    <!-- Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="./stylesheets/style.css">
  </head>
  <body>
    <!-- Import pixi js -->
    <script src="./libs/pixi.min.js"></script>
    <!-- Import jQuery js -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <!-- Import materialize js -->
    <script src="./libs/materialize/js/materialize.min.js"></script>
    <!-- Import for pastel syntax highlighting -->
    <script type="text/javascript" src="http://ajaxorg.github.io/ace-builds/src-noconflict/ace.js"></script>
    <script type="text/javascript" src="./libs/mode-pastel.js"></script>
    <!-- Import crafty_v2 -->
    <script type="text/javascript" src="./libs/block.js"></script>
    <script type="text/javascript" src="./libs/blocklibrary.js"></script>

    <!-- main contents of crafty -->
    <div class="row main-row">

      <!-- canvas-container parts -->
      <div class="col s8 canvas-container">
        <!-- title of main-canvas -->
        <blockquote>
          <h4>Canvas</h4>
        </blockquote>
        <!-- button: open-palette -->
        <a class="btn-floating btn-large waves-effect waves-light red open-palette"><i class="material-icons">add</i></a>
      </div>

      <!-- code-container parts -->
      <div class="col s4 code-container">
        <!-- title of code-container -->
        <blockquote>
          <h4>Pastel Code</h4>
        </blockquote>
        <!-- code-area parts using pastel syntax highlighting -->
        <div class="code-area-container">
          <pre class="code-area" id="editor">
# n!을 계산하는 프로그램
(define factorial n (
    (if (< n 2) (1)
        (* n (factorial (- n 1))))
))

# 피보나치 수열의 n항을 계산하는 프로그램
(define fibonacci n (
    (if (= n 0) (0)
    (if (= n 1) (1))
    (+ (fibonacci (- n 1)) (memoize fibonacci (- n 2))))
))

# 자연수 n이 소수인지 판별하는 프로그램
(define check (n c) (
    (if (< (square n) (prime c)) (true)
        ((if (zero (modular n (prime c))) (false)
             (check n (+ c 1)))))
))

# n번째 소수를 계산하는 프로그램
(define prime n (
    (if (= n 1) (2) (
    	(define search r (
    		(if (check r 1) (r) (search (+ r 1)))))
        (search (+ (prime (- n 1)) 1))))
))
</pre>
        </div>
      </div>

      <!-- live-preview parts -->
      <div>
        <!-- button: live-preview / Modal Trigger -->
        <a class="waves-effect waves-light btn modal-trigger btn-floating btn-large red live-preview" href="#run-results"><i class="material-icons">play_arrow</i></a>
        <!-- run-results parts = Modal Structure of live-preview button -->
        <div id="run-results" class="modal bottom-sheet">
          <div class="modal-content">
            <blockquote>
              live-preview
            </blockquote>
            <pre>
results!
results!
</pre>
          </div>
          <div class="modal-footer">
            <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">OK</a>
          </div>
        </div>
      </div>

    </div>


    <script>
    /* crafty_v2 parts */
    var renderer = PIXI.autoDetectRenderer(800, 600, {backgroundColor: 0xCCCCCC, antialias: true });
    renderer.view.style.position = "absolute";
    renderer.view.style.top = "100px";
    renderer.view.style.left ="125px";
    renderer.view.style.display = "block";
    renderer.autoResize = true;
    renderer.resize(window.innerWidth * 0.7 - 250, window.innerHeight - 200);
    document.body.appendChild(renderer.view);

    var stage = new PIXI.Container();
    stage.id = "stage";
    renderer.render(stage); // remove black flash
    stage.interactive = false;

    let SIDEBAR_STYLE = {width:200, backgroundColor:0xEEEEEE, };

    PIXI.loader
    .add("images/background-tile.png")
    .load(setup);

    function setup() {
      //  create and add background tile pattern
      var backgroundTile = new PIXI.extras.TilingSprite(
        PIXI.loader.resources["images/background-tile.png"].texture,
        17,
        17
      );
      backgroundTile.width = window.innerWidth;
      backgroundTile.height = window.innerHeight;
      stage.addChild(backgroundTile);


      //  create and add sidebar
      var sidebar = new PIXI.Graphics();
      sidebar.id = "sidebar";
      sidebar.beginFill(SIDEBAR_STYLE.backgroundColor,1);
      sidebar.drawRect(0,0,SIDEBAR_STYLE.width, window.innerHeight);
      sidebar.endFill();
      stage.addChild(sidebar);

      /*
      var ifBlockInfo = new BlockInfo("if", blockType.function, parameters = ["condition", "true-body", "false-body"], library = "standard")
      var addBlockInfo = new BlockInfo("+", blockType.function, parameters = ["a", "b"], library = "math")
      var equalsBlockInfo = new BlockInfo("=", blockType.function, parameters = ["a", "b"], library = "math")

      var addBlock = new Block(addBlockInfo);
      var equalsBlock = new Block(equalsBlockInfo);
      var ifBlock = new Block(ifBlockInfo, [null, addBlock, null]);

      ifBlock.position.set(SIDEBAR_STYLE.width + 10,10);
      stage.addChild(ifBlock);
      equalsBlock.position.set(SIDEBAR_STYLE.width + 10,10);
      stage.addChild(equalsBlock);
      */
      initializeBlockLibrary(sidebar);

      //  resize renderer, sidebar, backgroundTile when window is resized
      window.addEventListener('resize', function(event){
        backgroundTile.width = window.innerWidth;
        backgroundTile.height = window.innerHeight;
        sidebar.height = window.innerHeight;
        renderer.resize(window.innerWidth * 0.7 - 250, window.innerHeight - 200);
      });

      //  render animation
      animate();

      function animate() {
        renderer.render(stage);
        requestAnimationFrame( animate );
      }
    }


    /* pastel syntax highlighting parts */
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.session.setMode("ace/mode/pastel");

    $(document).ready(function(){
      /* set code-area's height */
      var document_height = $(document).height();
      $('.code-area').css('height', document_height-170);

      /* initiate modal-trigger for live-preview button */
      $('.modal-trigger').leanModal({
          dismissible: true, // Modal can be dismissed by clicking outside of the modal
          opacity: .5, // Opacity of modal background
          in_duration: 300, // Transition in duration
          out_duration: 200, // Transition out duration
          starting_top: '4%', // Starting top style attribute
          ending_top: '10%', // Ending top style attribute
        }
      );

      /* print console.log message when click open-palette button */
      $('.open-palette').click(function() {
        console.log('open-palette clicked - plz open palette, minwhoo!');
      });

      /* print console.log message when change codes in code-area */
      $('.code-area').keyup(function () {
        console.log('code-area changed - plz change canvas components, minwhoo!');
      });

    });

    $(window).resize(function() {
      /* set code-area's height, when window resize occured */
      var document_height = $(document).height();
      $('.code-area').css('height', document_height-170);
    });

    function canvasChanged() {
      var temp = '<pre>hi<br />hi<br /></pre>';
      temp.className += 'code-area';
      temp.id = 'editor';
      $('.code-area-container')[0].innerHTML = temp;
      console.log("hi");
      var document_height = $(document).height();
      $('.code-area').css('height', document_height-170);
    }
    </script>
  </body>
</html>
